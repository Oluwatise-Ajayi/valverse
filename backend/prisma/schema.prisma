// backend/prisma/schema.prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  profile   Profile?
  progress  Progress?
  sessions  Session[]
  storyState PlayerStoryState?
}

model Profile {
  id        String  @id @default(uuid())
  userId    String  @unique
  user      User    @relation(fields: [userId], references: [id])
  nickname  String?
  avatarUrl String?
}

model Progress {
  id             String   @id @default(uuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])
  
  // Stages
  valentineAnswer Boolean @default(false) // Accepted to be Valentine
  quizCompleted   Boolean @default(false)
  quizScore       Int     @default(0)
  
  // Game States (JSON for flexibility)
  gameStates     Json     @default("{}") // e.g. { "catchHearts": { "highScore": 150 }, "rpg": { "chapter": 2 } }
  
  // Unlocks
  unlockedMedia  Unlock[]
  
  lastSyncedAt   DateTime @default(now())
}

model Unlock {
  id        String   @id @default(uuid())
  progressId String
  progress   Progress @relation(fields: [progressId], references: [id])
  
  mediaId   String
  media     Media    @relation(fields: [mediaId], references: [id])
  
  unlockedAt DateTime @default(now())
}

model Media {
  id          String   @id @default(uuid())
  title       String
  description String?  // Added for compliments and other  metadata
  type        MediaType // IMAGE, VIDEO, AUDIO, TEXT, COMPLIMENT
  url         String   // Cloudinary public ID or URL
  requiredGame String  // The game ID required to unlock this
  threshold   Json     // Logic: { "score": 100 } or { "completion": true }
  
  unlocks     Unlock[]
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  token     String   @unique
  expiresAt DateTime
}

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
  TEXT
  COMPLIMENT
}

// Story RPG Engine Models
model StoryNode {
  id        String   @id // e.g., "C1_S1", "C5_END1"
  chapter   Int
  scene     Int
  text      String   @db.Text
  createdAt DateTime @default(now())
  
  choices   StoryChoice[]
  
  @@index([chapter])
}

model StoryChoice {
  id          String @id @default(uuid())
  nodeId      String
  node        StoryNode @relation(fields: [nodeId], references: [id])
  
  optionId    String  // e.g., "A", "B", "C"
  label       String
  nextNodeId  String
  
  // Stat effects
  trustDelta     Int @default(0)
  closenessDelta Int @default(0)
  securityDelta  Int @default(0)
  desireDelta    Int @default(0)
  
  @@unique([nodeId, optionId])
}

model PlayerStoryState {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  
  // Current position
  currentNodeId String @default("C1_S1")
  
  // Stats
  trust     Int @default(50)
  closeness Int @default(50)
  security  Int @default(50)
  desire    Int @default(50)
  
  // Choices made (for replay/analytics)
  choiceHistory Json @default("[]")
  
  // Completion
  isCompleted   Boolean @default(false)
  endingReached String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
}

